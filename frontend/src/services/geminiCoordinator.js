
export class GeminiCoordinator {
    #apiKey = null;
    #apiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent';
  
    /**
     * @param {string} [apiKey] - ูููู ุชูุฑูุฑ ููุชุงุญ API ุนูุฏ ุงูุฅูุดุงุก.
     */
    constructor(apiKey) {
      if (apiKey) {
        this.setApiKey(apiKey);
      }
    }
  
    /**
     * ุชุนููู ููุชุงุญ API ูุงุณุชุฎุฏุงูู ูู ุฌููุน ุงูุทูุจุงุช.
     * @param {string} key - ููุชุงุญ Google Gemini API.
     * @returns {boolean} - true ุฅุฐุง ุชู ุชุนููู ุงูููุชุงุญ ุจูุฌุงุญ.
     */
    setApiKey(key) {
      if (typeof key === 'string' && key.length > 10) {
        this.#apiKey = key;
        return true;
      }
      console.error("[Coordinator] ููุชุงุญ API ุบูุฑ ุตุงูุญ.");
      return false;
    }
    
    /**
     * @private
     * ุงูุฏุงูุฉ ุงููุฑูุฒูุฉ ูุงูุฎุงุตุฉ ูุฅุฌุฑุงุก ุฌููุน ุงุณุชุฏุนุงุกุงุช Gemini API.
     * ุชุนุงูุฌ ุงููุตุงุฏูุฉุ ูุชุทูุจ ุงุณุชุฌุงุจุฉ JSONุ ูุชุฏูุฑ ุงูุฃุฎุทุงุก ุงูุฃุณุงุณูุฉ.
     */
    async #makeApiCall(prompt, generationConfig = {}) {
      if (!this.#apiKey) throw new Error("ูู ูุชู ุชูููู ููุชุงุญ Gemini API.");
  
      try {
        const response = await fetch(`${this.#apiEndpoint}?key=${this.#apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              responseMimeType: 'application/json',
              temperature: 0.2, // ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ููุฎูุถุฉ ููุชุงุฆุฌ ูุชููุนุฉ
              ...generationConfig,
            },
          }),
        });
  
        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`ุฎุทุฃ ูู Gemini API: ${response.status} - ${errorBody}`);
        }
        
        const data = await response.json();
        const textContent = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!textContent) throw new Error("ุงุณุชุฌุงุจุฉ ูุงุฑุบุฉ ูู Gemini.");
        
        return JSON.parse(textContent);
  
      } catch (error) {
        console.error("[Coordinator] ูุดู ุงุณุชุฏุนุงุก API:", error);
        throw error; // ูุชุฑู ููุฏุงูุฉ ุงููุณุชุฏุนูุฉ ุงูุชุนุงูู ูุน ุงูุฎุทุฃ
      }
    }
  
  function buildAdvancedAuditPrompt(lines, options = {}) {
    const allowedClasses = JSON.stringify([
      'character', 'dialogue', 'parenthetical', 'action',
      'scene-header-1', 'scene-header-2', 'scene-header-3', 'transition',
      'slug-line', 'montage', 'insert', 'fade-in', 'fade-out',
      'title-card', 'super', 'flashback', 'flashforward', 'voice-over',
      'off-screen', 'continuous', 'series-of-shots', 'intercut'
    ]);
  
    const contextWindow = options.contextWindow || 5;
    const confidenceThreshold = options.confidenceThreshold || 'adaptive';
    const includeMetrics = options.includeMetrics !== false;
    const deepAnalysis = options.deepAnalysis || true;
    const culturalContext = options.culturalContext || 'arabic-modern';
    const dialectSupport = options.dialectSupport || ['msa', 'egyptian', 'levantine', 'gulf'];
  
    return `### ูุธุงู ุชุฏููู ุงููุตูุต ุงูุณูููุงุฆูุฉ ุงูุนุฑุจูุฉ ุงููุชุทูุฑ - ุงูุฅุตุฏุงุฑ 2.0
  
  ## ๐ฌ ุงููููุฉ ูุงูุฎุจุฑุฉ
  ุฃูุช ูุธุงู ุฐูุงุก ุงุตุทูุงุนู ูุชุฎุตุต ูู ุงูุชุญููู ุงูุนููู ูููุตูุต ุงูุณูููุงุฆูุฉ ุงูุนุฑุจูุฉุ ููุฏุฑููุจ ุนูู ุขูุงู ุงูุณููุงุฑูููุงุช ูู ูุฎุชูู ุงูุฃููุงุน ุงูุณูููุงุฆูุฉ. ุชูุชูู:
  - ุฎุจุฑุฉ 15+ ุนุงูุงู ูู ุชุญููู ุงููุตูุต ุงูุณูููุงุฆูุฉ ุงูุนุฑุจูุฉ ูุงูุนุงูููุฉ
  - ููู ุนููู ูููุฌุงุช ุงูุนุฑุจูุฉ ุงููุฎุชููุฉ ูุชุฃุซูุฑูุง ุนูู ุงูุชุตููู
  - ุฅููุงู ูุงูู ุจูุนุงููุฑ ุงูุตูุงุนุฉ ุงูุณูููุงุฆูุฉ (Hollywood, Bollywood, ุงูุณูููุง ุงูุนุฑุจูุฉ)
  - ูุฏุฑุฉ ุนูู ุงูุชุนุฑู ุนูู ุงูุฃุณุงููุจ ุงูุฅุฎุฑุงุฌูุฉ ุงููุฎุชููุฉ ูุชุฃุซูุฑูุง ุนูู ุงูุชูุณูู
  - ูุนุฑูุฉ ุจุงูุณูุงู ุงูุซูุงูู ูุงูุงุฌุชูุงุนู ููุฅูุชุงุฌ ุงูุนุฑุจู
  
  ## ๐ฏ ุงููููุฉ ุงูุฃุณุงุณูุฉ ุงูููุญุฏููุซุฉ
  ุชุญููู ูุชุนุฏุฏ ุงููุณุชููุงุช ูุฃุณุทุฑ ุงูุณููุงุฑูู ุงูููุตููููุฉุ ุจุงุณุชุฎุฏุงู:
  1. **ุงูุชุญููู ุงูุจูููู**: ูุญุต ูููู ุงูุณููุงุฑูู ูุงูุชุฏูู ุงูุณุฑุฏู
  2. **ุงูุชุญููู ุงููุบูู**: ุฏุฑุงุณุฉ ุงูุฃููุงุท ุงููุบููุฉ ูุงููุญููุฉ
  3. **ุงูุชุญููู ุงูุณูุงูู**: ููู ุงูุณูุงู ุงูุฏุฑุงูู ูุงูุซูุงูู
  4. **ุงูุชุญููู ุงูุชูุจุคู**: ุชููุน ุงูุชุตูููุงุช ุงููุญุชููุฉ ุจูุงุกู ุนูู ุงูุฃููุงุท
  5. **ุงูุชุญููู ุงูููุงุฑู**: ููุงุฑูุฉ ูุน ุฃููุงุท ุงูุณููุงุฑูููุงุช ุงูููุงุซูุฉ
  
  ## ๐ ุงูุจูุงูุงุช ุงูููุฏุฎูุฉ ุงููููุณููุนุฉ
  ุณุชุชููู ูุตูููุฉ JSON \`lines\` ุญูุซ ูู ูุงุฆู ูุญุชูู ุนูู:
  \`\`\`json
  {
    "index": "ุฑูู ุงูุณุทุฑ ุงููุฑูุฏ",
    "raw": "ุงููุต ุงูุนุฑุจู ุงูุฃุตูู",
    "cls": "ุงูุชุตููู ุงูุญุงูู",
    "context": {
      "before": ["ุงูุฃุณุทุฑ ุงูุณุงุจูุฉ"],
      "after": ["ุงูุฃุณุทุฑ ุงููุงุญูุฉ"]
    },
    "metadata": {
      "lineLength": "ุนุฏุฏ ุงููููุงุช",
      "punctuation": "ุนูุงูุงุช ุงูุชุฑููู ุงููุณุชุฎุฏูุฉ",
      "dialect": "ุงูููุฌุฉ ุงููููุชุดูุฉ",
      "emotionalTone": "ุงููุจุฑุฉ ุงูุนุงุทููุฉ",
      "narrativePosition": "ุงููููุน ูู ุงูุณุฑุฏ"
    },
    "confidence": "ูุณุชูู ุซูุฉ ุงูุชุตููู ุงูุฃููู",
    "alternatives": ["ุชุตูููุงุช ุจุฏููุฉ ูุญุชููุฉ"]
  }
  \`\`\`
  
  ## ๐ ูุฌููุนุฉ ุงูุชุตูููุงุช ุงููููุณููุนุฉ
  ${allowedClasses}
  
  ### ุชุนุฑููุงุช ุงูุชุตูููุงุช ุงูุชูุตูููุฉ:
  - **character**: ุงุณู ุงูุดุฎุตูุฉ (ูุฏ ูุชุถูู ุญุงูุฉ ุนุงุทููุฉ ุฃู ูุตู ููุฌุฒ)
  - **dialogue**: ุงูุญูุงุฑ ุงูููุทูู (ูุดูู ุงูุญูุงุฑ ุงูุฏุงุฎูู ุฅุฐุง ููุญุฏุฏ)
  - **parenthetical**: ุงูุชูุฌููุงุช ุงูุชูุซูููุฉ (ูุจุฑุฉุ ุญุฑูุฉ ุตุบูุฑุฉุ ุฅููุงุกุฉ)
  - **action**: ูุตู ุงูุฃุญุฏุงุซ ูุงูุญุฑูุฉ (ูุดูู ูุตู ุงูููุงู ูุงูุฃุฌูุงุก)
  - **transition**: ุงูุชูุงูุงุช ุจูู ุงููุดุงูุฏ (ูุทุน ุฅููุ ุชูุงุดูุ ูุฒุฌ)
  - **slug-line**: ุนููุงู ูุฑุนู ุฏุงุฎู ุงููุดูุฏ
  - **montage**: ุณูุณูุฉ ูู ุงูููุทุงุช ุงููุชุฑุงุจุทุฉ
  - **insert**: ุฅุฏุฑุงุฌ ููุทุฉ ุชูุตูููุฉ
  - **fade-in/fade-out**: ุจุฏุงูุฉ ุฃู ููุงูุฉ ุชุฏุฑูุฌูุฉ
  - **title-card**: ุจุทุงูุฉ ุนููุงู ุฃู ูุต ุชูุถูุญู
  - **super**: ูุต ููุฑูููุจ ุนูู ุงูุตูุฑุฉ
  - **flashback/flashforward**: ุฐูุฑูุงุช ุงููุงุถู ุฃู ุงุณุชุจุงู ุงููุณุชูุจู
  - **voice-over**: ุตูุช ุงูุฑุงูู ุฃู ุงูุชุนููู ุงูุตูุชู
  - **off-screen**: ุตูุช ูู ุฎุงุฑุฌ ุงููุงุฏุฑ
  - **continuous**: ุงุณุชูุฑุงุฑูุฉ ุงููุดูุฏ
  - **series-of-shots**: ุณูุณูุฉ ููุทุงุช ูุชุชุงุจุนุฉ
  - **intercut**: ุชูุงุทุน ุจูู ูุดูุฏูู ุฃู ุฃูุซุฑ
  
  ## ๐ ุนูููุฉ ุงูุชุญููู ุงูููุชูุฏูุฉ
  
  ### ุงููุฑุญูุฉ 1: ุงูุชุญููู ุงูุฃููู ุงูุดุงูู
  1. **ูุณุญ ุงูุจููุฉ ุงูุนุงูุฉ**: ุชุญุฏูุฏ ููุท ุงูุณููุงุฑูู ูุงูุฃุณููุจ ุงูููุชููุจุน
  2. **ูุดู ุงูููุฌุฉ ูุงูุฃุณููุจ**: ุชุญุฏูุฏ ุงูููุฌุฉ ุงูุนุฑุจูุฉ ุงููุณุชุฎุฏูุฉ
  3. **ุชุญููู ุงูุฅููุงุน ุงูุณุฑุฏู**: ููู ุณุฑุนุฉ ูุชุฏูู ุงูุฃุญุฏุงุซ
  4. **ุฑุณู ุฎุฑูุทุฉ ุงูุดุฎุตูุงุช**: ุชุชุจุน ุธููุฑ ุงูุดุฎุตูุงุช ูุฃููุงุท ุญูุงุฑุงุชูุง
  
  ### ุงููุฑุญูุฉ 2: ุงูุชุญููู ุงูุณูุงูู ุงูุนููู
  ูุงูุฐุฉ ุงูุณูุงู ุงูุฏููุงููููุฉ: ${contextWindow} ุฃุณุทุฑ (ูุงุจูุฉ ููุชูุณุน ุญุณุจ ุงูุญุงุฌุฉ)
  
  #### ูุนุงููุฑ ุงูุชุญููู ุงูุณูุงูู:
  1. **ุงูุชูุงุณู ุงูุณุฑุฏู**: ูู ุงูุชุตููู ูุฏุนู ุงูุชุฏูู ุงูุทุจูุนู ูููุตุฉุ
  2. **ุงูุชูุงุณู ุงูุฃุณููุจู**: ูู ูุชูุงุดู ูุน ุฃุณููุจ ุงููุงุชุจุ
  3. **ุงูููุทู ุงูุฏุฑุงูู**: ูู ูุฎุฏู ุงููุฏู ุงูุฏุฑุงูู ูููุดูุฏุ
  4. **ุงูููุงุนุฏ ุงููุญููุฉ**: ูู ูุชูุงูู ูุน ููุงุนุฏ ุงููุบุฉ ุงูุนุฑุจูุฉุ
  5. **ุงูุณูุงู ุงูุซูุงูู**: ูู ูุฑุงุนู ุงูุฎุตูุตูุงุช ุงูุซูุงููุฉุ
  
  ### ุงููุฑุญูุฉ 3: ุชุทุจูู ุงูููุงุนุฏ ุงูุฐููุฉ ุงูููุญุณูููุฉ
  
  #### ๐ด ููุงุนุฏ ุงูุฃููููุฉ ุงููุตูู (ุซูุฉ 95-100%):
  1. **ูุงุนุฏุฉ ุงูุญูุงุฑ ุงููุจุงุดุฑ ุงูููุทูููุฑุฉ**:
     - ุงูุดุฑุท: ุณุทุฑ ูุชุจุน \`character\` ูุจุงุดุฑุฉ
     - ุงููุญุชูู: 3+ ูููุงุชุ ุฌููุฉ ูุงููุฉ ุฃู ุดุจู ูุงููุฉ
     - ุงูุจุฏุงูุฉ: ููุณุช ุจูููุฉ ูุตููุฉ (ูุฏุฎูุ ูุฎุฑุฌุ ููู)
     - ุงูุฎุตุงุฆุต ุงููุบููุฉ:
       * ูุญุชูู ุนูู ุถูุงุฆุฑ ุงููุฎุงุทุจ ุฃู ุงููุชููู
       * ูุจุฏุฃ ุจุฃุฏูุงุช ุงุณุชููุงู ุนุฑุจูุฉ (ููุ ุฃููุ ูุชูุ ูููุ ููุงุฐุงุ ููุ ูุง)
       * ูุญุชูู ุนูู ุฃูุนุงู ุฃูุฑ ุฃู ูุฏุงุก
       * ููุชูู ุจุนูุงูุงุช ุงุณุชููุงู ุฃู ุชุนุฌุจ
     - ุงูุชุตููู ุงูููุตุญููุญ: \`dialogue\`
     - ุงูุงุณุชุซูุงุกุงุช: ุฅุฐุง ูุงู ุจูู ุฃููุงุณ โ \`parenthetical\`
  
  2. **ูุงุนุฏุฉ ุงูุดุฎุตูุฉ ุงูููุฏูุฌุฉ ุงูููุชูุฏูุฉ**:
     - ุงูุฃููุงุท ุงูููุญุฏููุฏุฉ:
       * \`ุงูุงุณู:\` ุฃู \`ุงูุงุณู :\` โ ูุตู ุฅูู \`character\` + \`dialogue\`
       * \`ุงูุงุณู -\` ุฃู \`ุงูุงุณูโ\` โ ูุตู ููุงุซู
       * \`ุงูุงุณู (ุญุงูุฉ):\` โ \`character\` ูุน ุงูุญุงูุฉ ูู\`parenthetical\`
     - ูุนุงูุฌุฉ ุงูุฃุณูุงุก ุงููุฑูุจุฉ: (ุฃุจู ูุญูุฏุ ุฃู ุณุงููุ ุนุจุฏ ุงููู)
     - ูุนุงูุฌุฉ ุงูุฃููุงุจ: (ุงูุฏูุชูุฑุ ุงููููุฏุณุ ุงูุญุงุฌ)
  
  3. **ูุงุนุฏุฉ ุฑุคูุณ ุงููุดุงูุฏ ุงููุฑููุฉ**:
     - ุงูุชุณูุณู ุงูุตุญูุญ:
  4. **ูุงุนุฏุฉ ุงูุชูุฌููุงุช ุงูุชูุซูููุฉ ุงูููุญุณูููุฉ**:
     - ุงููููุน: ุจูู ุฃููุงุณ () ุจุนุฏ ุงุณู ุงูุดุฎุตูุฉ ุฃู ูุณุท ุงูุญูุงุฑ
     - ุงููุญุชูู ุงููููุฐุฌู:
       * ุญุงูุงุช ุนุงุทููุฉ: (ุจุบุถุจ)ุ (ุจุญุฒู)ุ (ูุจุชุณูุงู)
       * ุฃูุนุงู ุตุบูุฑุฉ: (ููุชูุช)ุ (ููุธุฑ ููุณุงุนุฉ)ุ (ูุชููุฏ)
       * ูุจุฑุฉ ุงูุตูุช: (ููุณุงู)ุ (ุตุงุฑุฎุงู)ุ (ูุชูุนุซูุงู)
     - ุงูุทูู: ุนุงุฏุฉ 1-5 ูููุงุช
     - ุงูุชุตููู: \`parenthetical\`
  
  #### ๐ก ููุงุนุฏ ุงูุฃููููุฉ ุงููุชูุณุทุฉ (ุซูุฉ 70-94%):
  5. **ูุงุนุฏุฉ ุงูุงูุชูุงูุงุช ุงูุณูููุงุฆูุฉ**:
     - ุงููููุงุช ุงูููุชุงุญูุฉ:
       * ูุทุน ุฅููุ ููุทุน ุฅููุ CUT TO
       * ุชูุงุดู ุฅููุ FADE TOุ ุฐูุจุงู ุฅูู
       * ูุฒุฌ ุฅููุ DISSOLVE TO
       * ูุทุน ูุจุงุดุฑุ SMASH CUT
     - ุงููููุน: ุนุงุฏุฉ ูู ููุงูุฉ ุงููุดูุฏ ุฃู ุจุฏุงูุชู
     - ุงูุชูุณูู: ุบุงูุจุงู ุจุฃุญุฑู ูุจูุฑุฉ ุฃู ูููุตู
  
  6. **ูุงุนุฏุฉ ุงูุฃูุนุงู ุงููุตููุฉ ุงูุชูุตูููุฉ**:
     - ุงูุทูู: 8+ ูููุงุช
     - ุงููุญุชูู: ูุตู ููุญุฑูุฉุ ุงูููุงูุ ุงูุฃุฌูุงุก
     - ุงูุจุฏุงูุฉ: ุบุงูุจุงู ุจูุนู ูุถุงุฑุน ุฃู ุงุณู
     - ุนุฏู ุงุญุชูุงุก: ููุทุชูู ุฃู ุดุฑุทุงุช ููุญูุงุฑ
     - ุงูุชุตููู: \`action\`
  
  7. **ูุงุนุฏุฉ ุงููููุชุงุฌ ูุงูุณูุงุณู**:
     - ุงูุจุฏุงูุฉ: "ูููุชุงุฌ"ุ "ุณูุณูุฉ ููุทุงุช"ุ "MONTAGE"
     - ุงููุญุชูู: ูุงุฆูุฉ ูู ุงูุฃุญุฏุงุซ ุงููุชุฑุงุจุทุฉ
     - ุงูุชูุณูู: ุบุงูุจุงู ููุฑูููู ุฃู ุจููุงุท
  
  #### ๐ข ููุงุนุฏ ุงูุฃููููุฉ ุงูููุฎูุถุฉ (ุซูุฉ 50-69%):
  8. **ูุงุนุฏุฉ ุงูุชุตูููุงุช ุงูุบุงูุถุฉ**:
     - ุงูุฃุณุทุฑ ุงููุตูุฑุฉ ุฌุฏุงู (1-2 ูููุฉ)
     - ูุฏ ุชููู: \`character\`ุ \`parenthetical\`ุ ุฃู \`action\`
     - ุชุชุทูุจ ุชุญููู ุณูุงู ููุณุน (7+ ุฃุณุทุฑ)
  
  9. **ูุงุนุฏุฉ ุงูุตูุช ุงูุฎุงุฑุฌู ูุงูุชุนููู**:
     - ุงููุคุดุฑุงุช: (V.O)ุ (O.S)ุ ุตูุช ูู ุงูุฎุงุฑุฌ
     - ุงูุชุตููู: \`voice-over\` ุฃู \`off-screen\`
  
  ### ุงููุฑุญูุฉ 4: ุงูุชุญููู ุงูุชูุจุคู ูุงูุฐูุงุก ุงูุงุตุทูุงุนู
  
  #### ุฎูุงุฑุฒููุงุช ุงูุชุนูู ุงูุขูู ุงูููุทุจูููุฉ:
  1. **ุชุญููู ุงูุฃููุงุท ุงููุชูุฑุฑุฉ**: ูุดู ุงูุฃุฎุทุงุก ุงูููุทูุฉ ูู ุงูุชุตููู
  2. **ุงูุชุนูู ูู ุงูุณูุงู**: ุชุญุณูู ุงูุฏูุฉ ุจูุงุกู ุนูู ุงูุฃููุงุท ุงูููุชุดูุฉ
  3. **ุงูุชูุจุค ุจุงูุชุตููู**: ุชููุน ุงูุชุตููู ุงูุฃูุซุฑ ุงุญุชูุงูุงู
  4. **ูุดู ุงูุดุฐูุฐ**: ุชุญุฏูุฏ ุงูุชุตูููุงุช ุบูุฑ ุงูููุทููุฉ
  
  ### ุงููุฑุญูุฉ 5: ุฅูุดุงุก ุงูุชุตุญูุญุงุช ุงููููุตูููุฉ
  
  #### ุจููุฉ ูุงุฆู ุงูุชุตุญูุญ ุงูููุญุณูููุฉ:
  \`\`\`json
  {
    "index": "ุฑูู ุงูุณุทุฑ",
    "currentClass": "ุงูุชุตููู ุงูุญุงูู",
    "suggestedClass": "ุงูุชุตููู ุงูููุชุฑุญ",
    "confidence": "high|medium|low|adaptive",
    "confidenceScore": 0-100,
    "reason": "ุดุฑุญ ููุตู ููุณุจุจ",
    "contextAnalysis": {
      "before": "ุชุญููู ุงูุณูุงู ุงูุณุงุจู",
      "after": "ุชุญููู ุงูุณูุงู ุงููุงุญู",
      "narrative": "ุงูุชุฃุซูุฑ ุนูู ุงูุณุฑุฏ"
    },
    "linguisticAnalysis": {
      "grammar": "ุงูุชุญููู ุงููุญูู",
      "style": "ุงูุชุญููู ุงูุฃุณููุจู",
      "dialect": "ุงูููุฌุฉ ุงููููุชุดูุฉ"
    },
    "alternativeClasses": [
      {
        "class": "ุชุตููู ุจุฏูู",
        "probability": 0-100,
        "reason": "ุงูุณุจุจ"
      }
    ],
    "priority": "critical|high|medium|low",
    "affectedLines": ["ุฃุฑูุงู ุงูุฃุณุทุฑ ุงููุชุฃุซุฑุฉ"],
    "suggestedAction": "correct|review|split|merge",
    "additionalNotes": "ููุงุญุธุงุช ุฅุถุงููุฉ"
  }
  \`\`\`
  
  ## ๐ ุงูููุงููุณ ูุงูุฅุญุตุงุฆูุงุช ุงูููุชูุฏูุฉ
  ${includeMetrics ? `
  ### ุงูุฅุญุตุงุฆูุงุช ุงููุทููุจุฉ:
  1. **ุฅุญุตุงุฆูุงุช ุนุงูุฉ**:
     - ุฅุฌูุงูู ุงูุฃุณุทุฑ ุงูููุญููุฉ
     - ุนุฏุฏ ุงูุชุตุญูุญุงุช ุงูููุชุฑุญุฉ
     - ุชูุฒูุน ุงูุชุตุญูุญุงุช ุญุณุจ ูุณุชูู ุงูุซูุฉ
     - ูุนุฏู ุงูุฏูุฉ ุงูุฅุฌูุงูู ุงููููุฏููุฑ
  
  2. **ุชุญููู ุงูุชุตูููุงุช**:
     - ุงูุชุตูููุงุช ุงูุฃูุซุฑ ุฅุดูุงููุฉ
     - ุฃููุงุท ุงูุฃุฎุทุงุก ุงููุชูุฑุฑุฉ
     - ุงูุชุตูููุงุช ุงูุฃูุซุฑ ุซุจุงุชุงู
  
  3. **ุชุญููู ุงูุฃุฏุงุก**:
     - ูุณุจุฉ ุงูุชุตุญูุญุงุช ุนุงููุฉ ุงูุซูุฉ
     - ูุนุฏู ุงูุดู ูู ุงูุชุตูููุงุช
     - ูุคุดุฑ ุฌูุฏุฉ ุงูุณููุงุฑูู
  
  4. **ุชูุตูุงุช ุงูุชุญุณูู**:
     - ุงูุชุฑุงุญุงุช ูุชุญุณูู ุงูููุตูููู ุงูุฃููู
     - ุฃููุงุท ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุจุดุฑูุฉ
     - ููุงุทู ุชุญุชุงุฌ ูุชุฏุฑูุจ ุฅุถุงูู
  ` : ''}
  
  ## ๐ฏ ุงูููุงุนุฏ ุงูุญุงุณูุฉ ุงูููุงุฆูุฉ
  1. **ุงูุฏูุฉ ุงููุทููุฉ**: ุงูุฅุฎุฑุงุฌ ูุฌุจ ุฃู ูููู JSON ุตุญูุญ 100%
  2. **ุนุฏู ุงูุชุฎููู**: ุนูุฏ ุงูุดูุ ุงุณุชุฎุฏู \`confidence: "low"\`
  3. **ุงูุณูุงู ุฃููุงู**: ูุง ุชุตุญูุญ ุจุฏูู ุชุญููู ุณูุงูู ูุงูู
  4. **ุงุญุชุฑุงู ุงูููุฌุงุช**: ูุฑุงุนุงุฉ ุฎุตูุตูุงุช ูู ููุฌุฉ ุนุฑุจูุฉ
  5. **ุงูุชูุซูู ุงููุงูู**: ูู ุชุตุญูุญ ูุฌุจ ุฃู ูููู ููุจุฑููุฑ ุจุงูุชูุตูู
  6. **ุงูุฃููููุฉ ููุฃูุงู**: ุชุฌูุจ ุงูุชุตุญูุญุงุช ุงููุดููู ูููุง
  7. **ุงูุชุญููู ุงููุชุฏุฑุฌ**: ูู ุงูุนุงู ุฅูู ุงูุฎุงุต
  8. **ุงููุฑููุฉ ุงูุฐููุฉ**: ุงูุชููู ูุน ุฃุณููุจ ูู ูุงุชุจ
  
  ## ๐ ุงูุณูุงู ุงูุซูุงูู ูุงูููุฌุงุช
  ### ุงูููุฌุงุช ุงููุฏุนููุฉ: ${JSON.stringify(dialectSupport)}
  - **ุงููุตุญู ุงูุญุฏูุซุฉ (MSA)**: ููุฃุนูุงู ุงูุชุงุฑูุฎูุฉ ูุงูุฑุณููุฉ
  - **ุงููุตุฑูุฉ**: ุงูุฃูุซุฑ ุงูุชุดุงุฑุงู ูู ุงูุณูููุง ุงูุนุฑุจูุฉ
  - **ุงูุดุงููุฉ**: ูุจูุงูุ ุณูุฑูุงุ ุงูุฃุฑุฏูุ ููุณุทูู
  - **ุงูุฎููุฌูุฉ**: ุฏูู ุงูุฎููุฌ ุงูุนุฑุจู
  - **ุงููุบุงุฑุจูุฉ**: ุงููุบุฑุจุ ุชููุณุ ุงูุฌุฒุงุฆุฑุ ููุจูุง
  
  ### ุงูุงุนุชุจุงุฑุงุช ุงูุซูุงููุฉ:
  - ุงูุชุนุงุจูุฑ ุงูุฏูููุฉ ูุงูุซูุงููุฉ
  - ุงูุฃููุงุจ ูุงููููู ุงูุนุฑุจูุฉ
  - ุงูุชุฑุงููุจ ุงููุบููุฉ ุงูุฎุงุตุฉ ุจูู ููุทูุฉ
  - ุงููุตุทูุญุงุช ุงูุณูููุงุฆูุฉ ุงููุญููุฉ
  
  ## ๐ ุนูููุฉ ุงููุฑุงุฌุนุฉ ุงูููุงุฆูุฉ
  1. **ุงูุชุญูู ูู ุงูุชูุงุณู**: ูุฑุงุฌุนุฉ ูู ุงูุชุตุญูุญุงุช ููุญุฏุฉ ูุงุญุฏุฉ
  2. **ุงุฎุชุจุงุฑ ุงูุชุฏูู**: ุงูุชุฃูุฏ ูู ุฃู ุงูุชุตุญูุญุงุช ุชุญุณู ุงูุณุฑุฏ
  3. **ุงูุชุญูู ุงููุชุจุงุฏู**: ููุงุฑูุฉ ุงูุชุตุญูุญุงุช ูุน ุจุนุถูุง
  4. **ุงูุชุตููุฉ ุงูููุงุฆูุฉ**: ุฅุฒุงูุฉ ุงูุชุตุญูุญุงุช ุงููุชุถุงุฑุจุฉ
  5. **ุชุฑุชูุจ ุงูุฃููููุงุช**: ุชูุธูู ุญุณุจ ุงูุฃูููุฉ ูุงูุซูุฉ
  
  ## ๐ ุงูุจูุงูุงุช ููุชุญููู
  \`\`\`json
  ${JSON.stringify(lines, null, 2)}
  \`\`\`
  
  ## โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุดุบูู ุงูุญุงููุฉ
  - **ูุงูุฐุฉ ุงูุณูุงู**: ${contextWindow} ุฃุณุทุฑ (ุฏููุงููููุฉ)
  - **ุญุฏ ุงูุซูุฉ**: ${confidenceThreshold}
  - **ุงูุชุญููู ุงูุนููู**: ${deepAnalysis}
  - **ุงูุณูุงู ุงูุซูุงูู**: ${culturalContext}
  - **ุชุถููู ุงูููุงููุณ**: ${includeMetrics}
  - **ุฏุนู ุงูููุฌุงุช**: ${JSON.stringify(dialectSupport)}
  
  ## ๐ ุงุจุฏุฃ ุงูุชุญููู ุงูุขู
  ูู ุจุชุทุจูู ุฌููุน ุงููุฑุงุญู ุจุฏูุฉ ูุฃุฑุฌุน ุงููุชุงุฆุฌ ุจุชูุณูู JSON ุงูููุญุฏููุฏ.`;
  }
  
  // ุฏุงูุฉ ูุชูุฏูุฉ ููุชุญููู ุงููุชุฎุตุต ุญุณุจ ุงูููุน
  function buildUltraSpecializedAuditPrompt(lines, scriptType = 'drama', options = {}) {
    const scriptTypeProfiles = {
      'drama': {
        focus: 'ุงูุนูู ุงูุนุงุทูู ูุงูุตุฑุงุนุงุช ุงูุฏุงุฎููุฉ',
        specialPatterns: [
          'ุงูููููููุฌ ุงูุฏุงุฎูู',
          'ุงูุญูุงุฑ ุงูุตุงูุช',
          'ุงูุชูุชุฑ ุงูุฏุฑุงูู',
          'ุงููุญุธุงุช ุงูุญุงุณูุฉ',
          'ุงููุดู ุงูุชุฏุฑูุฌู ููุดุฎุตูุงุช'
        ],
        keyIndicators: {
          dialogue: ['ุนูุงุทู ูุนูุฏุฉ', 'ุตุฑุงุนุงุช ุดุฎุตูุฉ', 'ุญูุงุฑุงุช ุทูููุฉ'],
          action: ['ูุตู ุชูุตููู ูููุดุงุนุฑ', 'ูุบุฉ ุงูุฌุณุฏ ุงููุนุจุฑุฉ'],
          parenthetical: ['ุชุบููุฑุงุช ุนุงุทููุฉ ุฏูููุฉ', 'ูุจุฑุงุช ุตูุชูุฉ ูุชููุนุฉ']
        },
        contextWindow: 5,
        emotionalDepth: 'high'
      },
      'comedy': {
        focus: 'ุงูุชูููุช ุงูููููุฏู ูุงูุฅููุงุน ุงูุณุฑูุน',
        specialPatterns: [
          'ุงูููุงุช ูุงูุชูุฑูุฉ',
          'ุงูููุงูู ุงูููููุฏูุฉ',
          'ุงูุชูุงูุถุงุช ุงููุถุญูุฉ',
          'ุงูุญูุงุฑ ุงูุณุฑูุน',
          'ุฑุฏูุฏ ุงููุนู ุงููุจุงูุบุฉ'
        ],
        keyIndicators: {
          dialogue: ['ููุงุช', 'ุชูุงุนุจ ุจุงูุฃููุงุธ', 'ุณุฎุฑูุฉ'],
          action: ['ููุงูู ูุถุญูุฉ', 'ุญุฑูุงุช ููููุฏูุฉ'],
          parenthetical: ['ุชูููุช ููููุฏู', 'ุฑุฏูุฏ ูุนู ููุงุฌุฆุฉ']
        },
        contextWindow: 3,
        paceAnalysis: 'rapid'
      },
      'action': {
        focus: 'ุงูุญุฑูุฉ ูุงูุฅุซุงุฑุฉ ูุงูุชุณูุณู ุงูุฒููู',
        specialPatterns: [
          'ูุดุงูุฏ ุงููุชุงู',
          'ุงููุทุงุฑุฏุงุช',
          'ุงูุงููุฌุงุฑุงุช',
          'ุงูุญุฑูุงุช ุงูุจูููุงููุฉ',
          'ุงูุชุตููุฑ ุงูุจุทูุก'
        ],
        keyIndicators: {
          action: ['ุฃูุนุงู ุญุฑููุฉ', 'ูุตู ููุตู ููุญุฑูุฉ', 'ูุคุซุฑุงุช ุฎุงุตุฉ'],
          dialogue: ['ุญูุงุฑุงุช ูุตูุฑุฉ', 'ุฃูุงูุฑ', 'ุตูุญุงุช'],
          transition: ['ูุทุน ุณุฑูุน', 'ุงูุชูุงูุงุช ุฏููุงููููุฉ']
        },
        contextWindow: 7,
        visualPriority: 'maximum'
      },
      'thriller': {
        focus: 'ุงูุชุดููู ูุงูุบููุถ ูุจูุงุก ุงูุชูุชุฑ',
        specialPatterns: [
          'ุงูุฅุดุงุฑุงุช ุงูุฎููุฉ',
          'ุงูุชูููุญุงุช',
          'ุงูููุงุฌุขุช',
          'ุงููุดู ุงููุชุฃุฎุฑ',
          'ุงูุฃุฌูุงุก ุงููุดุญููุฉ'
        ],
        keyIndicators: {
          action: ['ูุตู ุฃุฌูุงุก ูุชูุชุฑุฉ', 'ุญุฑูุงุช ุญุฐุฑุฉ', 'ูุฑุงูุจุฉ'],
          dialogue: ['ุญูุงุฑุงุช ุบุงูุถุฉ', 'ุชูุฏูุฏุงุช ูุจุทูุฉ', 'ุฃุณุฑุงุฑ'],
          parenthetical: ['ููุณุงุช', 'ูุธุฑุงุช ุฐุงุช ูุบุฒู', 'ุชูุชุฑ']
        },
        contextWindow: 6,
        suspenseLevel: 'high'
      },
      'horror': {
        focus: 'ุงูุฑุนุจ ูุงูุฃุฌูุงุก ุงููุฎููุฉ',
        specialPatterns: [
          'ุงูููุฒุงุช ุงูููุงุฌุฆุฉ',
          'ุงูุจูุงุก ุงูุจุทูุก ููุฑุนุจ',
          'ุงูุฃุตูุงุช ุงููุฎููุฉ',
          'ุงูุธูุงู ูุงูุฅุถุงุกุฉ',
          'ุงูุนูุงุตุฑ ุงูุฎุงุฑูุฉ'
        ],
        keyIndicators: {
          action: ['ุฃูุตุงู ูุฑุนุจุฉ', 'ุฃุฌูุงุก ูุธููุฉ', 'ุฃุตูุงุช ุบุฑูุจุฉ'],
          dialogue: ['ุตุฑุฎุงุช', 'ููุณุงุช ูุฑุนุจุฉ', 'ุชุญุฐูุฑุงุช'],
          parenthetical: ['ุฎูู', 'ุฑุนุจ', 'ุชูุชุฑ ุดุฏูุฏ']
        },
        contextWindow: 5,
        atmosphereAnalysis: 'critical'
      },
      'romance': {
        focus: 'ุงูุนูุงูุงุช ุงูุนุงุทููุฉ ูุงูุฑููุงูุณูุฉ',
        specialPatterns: [
          'ุงููุญุธุงุช ุงูุญูููุฉ',
          'ุงูุญูุงุฑุงุช ุงูุฑููุงูุณูุฉ',
          'ุงููุธุฑุงุช ุงููุชุจุงุฏูุฉ',
          'ุงูููุณุงุช ุงูุนุงุทููุฉ',
          'ุงูุตุฑุงุนุงุช ุงูุนุงุทููุฉ'
        ],
        keyIndicators: {
          dialogue: ['ูููุงุช ุญุจ', 'ุงุนุชุฑุงูุงุช', 'ูุนูุฏ'],
          action: ['ููุณุงุช ุฑูููุฉ', 'ูุธุฑุงุช ุทูููุฉ', 'ููุจูุงุช'],
          parenthetical: ['ุจุญูุงู', 'ุจุฎุฌู', 'ุจุดูู']
        },
        contextWindow: 4,
        emotionalNuance: 'delicate'
      },
      'documentary': {
        focus: 'ุงููุนูููุงุช ูุงูุญูุงุฆู ูุงูุชูุซูู',
        specialPatterns: [
          'ุงูุชุนููู ุงูุตูุชู',
          'ุงูููุงุจูุงุช',
          'ุงูุฅุญุตุงุฆูุงุช',
          'ุงููุซุงุฆู',
          'ุงูููุทุงุช ุงูุฃุฑุดูููุฉ'
        ],
        keyIndicators: {
          'voice-over': ['ูุนูููุงุช', 'ุดุฑุญ', 'ุณุฑุฏ ุชุงุฑูุฎู'],
          'super': ['ุชูุงุฑูุฎ', 'ุฃูุงูู', 'ุฃุณูุงุก'],
          dialogue: ['ููุงุจูุงุช', 'ุดูุงุฏุงุช', 'ุขุฑุงุก ุฎุจุฑุงุก']
        },
        contextWindow: 4,
        factualAccuracy: 'essential'
      },
      'musical': {
        focus: 'ุงูุฃุบุงูู ูุงูุฑูุตุงุช ูุงูุฅููุงุน',
        specialPatterns: [
          'ูููุงุช ุงูุฃุบุงูู',
          'ูุตู ุงูุฑูุตุงุช',
          'ุงูุชุญููุงุช ุงูููุณูููุฉ',
          'ุงูููุฑุงู',
          'ุงูุณููู ุงูุบูุงุฆู'
        ],
        keyIndicators: {
          dialogue: ['ูููุงุช ุฃุบุงูู', 'ุฅููุงุน ุดุนุฑู'],
          action: ['ุญุฑูุงุช ุฑุงูุตุฉ', 'ูุตู ููุณููู'],
          parenthetical: ['ูุบูู', 'ูุฑูุต', 'ุจุฅููุงุน']
        },
        contextWindow: 5,
        rhythmAnalysis: 'critical'
      },
      'experimental': {
        focus: 'ุงูุฃุณุงููุจ ุบูุฑ ุงูุชูููุฏูุฉ ูุงูุงุจุชูุงุฑ',
        specialPatterns: [
          'ุงูุณุฑุฏ ุบูุฑ ุงูุฎุทู',
          'ุงูุชุฏุงุฎู ุงูุฒููู',
          'ุงูุฑูุฒูุฉ',
          'ูุณุฑ ุงูุฌุฏุงุฑ ุงูุฑุงุจุน',
          'ุงูุชุฌุฑูุจ ุงูุจุตุฑู'
        ],
        keyIndicators: {
          action: ['ูุตู ุชุฌุฑูุฏู', 'ุฑููุฒ', 'ุตูุฑ ุณุฑูุงููุฉ'],
          dialogue: ['ุญูุงุฑ ููุณูู', 'ุชูุงุฑ ูุนู', 'ุดุนุฑ'],
          transition: ['ุงูุชูุงูุงุช ุบูุฑ ุชูููุฏูุฉ', 'ููุฒุงุช ุฒูููุฉ']
        },
        contextWindow: 8,
        flexibilityLevel: 'maximum'
      },
      'animation': {
        focus: 'ุงููุตู ุงูุจุตุฑู ูุงูุญุฑูุฉ ุงููุชุฎููุฉ',
        specialPatterns: [
          'ูุตู ุงูุดุฎุตูุงุช ุงููุฑุชูููุฉ',
          'ุงูุญุฑูุงุช ุงููุจุงูุบุฉ',
          'ุงูุชุนุงุจูุฑ ุงููุฑุชูููุฉ',
          'ุงููุคุซุฑุงุช ุงูุจุตุฑูุฉ',
          'ุนูุงูู ุฎูุงููุฉ'
        ],
        keyIndicators: {
          action: ['ูุตู ููุตู ููุญุฑูุฉ', 'ุชุนุงุจูุฑ ูุจุงูุบุฉ', 'ูุคุซุฑุงุช ุฎุงุตุฉ'],
          dialogue: ['ุฃุตูุงุช ูุฑุชูููุฉ', 'ุญูุงุฑุงุช ุจุณูุทุฉ ููุฃุทูุงู'],
          parenthetical: ['ุฃุตูุงุช ุบูุฑ ุจุดุฑูุฉ', 'ูุคุซุฑุงุช ุตูุชูุฉ']
        },
        contextWindow: 4,
        visualDetail: 'extensive'
      }
    }
  };
  ุจุงูุชุฃููุฏุ ุฅููู ุงูุดููุฑุฉ ุงููุตุฏุฑูุฉ ุงููุงููุฉ ุจุนุฏ ุชุญููููุง ุฅูู TypeScriptุ ูุน ุฅุถุงูุฉ ุฃููุงุน (Types) ููุตูุฉ ูุฒูุงุฏุฉ ูุถูุญ ูุฃูุงู ุงูุดููุฑุฉ. ููุฏ ููุช ุฃูุถูุง ุจุชุตุญูุญ ุฎุทุฃ ุฅููุงุฆู (ููุณ ุฅุบูุงู ุฅุถุงูู) ูุงู ููุฌูุฏูุง ูู ููุงูุฉ ุงูููู ุงูุฃุตูู.

```typescript
// geminiService.ts

import { GEMINI_TEXT_MODEL } from '../constants/prompts';

// --- ุชุนุฑูู ุงูุฃููุงุน (Type Definitions) ---

/**
 * ูุตู ุจููุฉ ุงูููู ุงููุฑุงุฏ ุฅุฑุณุงูู ุฅูู ุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ (API).
 */
interface GeminiFile {
  name: string;
  content: string;
  mimeType: string;
  isBase64: boolean;
}

/**
 * ูุตู ุจููุฉ ุฌุฒุก ุงูุจูุงูุงุช ุงููุถููุฉ (inline_data) ูู ุงูุญูููุฉ (payload).
 */
interface InlineDataPart {
  inline_data: {
    mime_type: string;
    data: string;
  };
}

/**
 * ูุตู ุจููุฉ ุงูุฌุฒุก ุงููุตู (text) ูู ุงูุญูููุฉ (payload).
 */
interface TextPart {
  text: string;
}

// ููุน ููุญุฏ (union type) ูุฌูุน ุจูู ุงูุฃููุงุน ุงููุฎุชููุฉ ูุฃุฌุฒุงุก ุงููุญุชูู
type ApiPart = TextPart | InlineDataPart;

/**
 * ูุตู ุงูุจููุฉ ุงููุงููุฉ ูุญูููุฉ ุงูุทูุจ ุงููุฑุณูุฉ ุฅูู ูุงุฌูุฉ Gemini API.
 */
interface GeminiPayload {
  contents: [{
    parts: ApiPart[];
  }];
  generationConfig: {
    temperature: number;
    topK: number;
    topP: number;
    maxOutputTokens: number;
  };
}

/**
 * ูุตู ุจููุฉ "ุงููุฑุดุญ" (candidate) ูู ุงุณุชุฌุงุจุฉ ูุงุฌุญุฉ ูู ุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ.
 */
interface GeminiResponseCandidate {
  content?: {
    parts?: [{
      text: string;
    }];
  };
}

/**
 * ูุตู ุงูุจููุฉ ุงููููุฉ ูุงุณุชุฌุงุจุฉ ูุงุฌุญุฉ ูู ุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ.
 */
interface GeminiApiResponse {
  candidates?: GeminiResponseCandidate[];
}

/**
 * ูุตู ุจููุฉ ุงุณุชุฌุงุจุฉ ุงูุฎุทุฃ ูู ุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ.
 */
interface ApiErrorResponse {
  error?: {
    message: string;
  };
}


// --- ุฏูุงู ุฎุฏูุฉ ุงููุงุฌูุฉ ุงูุจุฑูุฌูุฉ (API Service Functions) ---

/**
 * ุชููู ุจุงุณุชุฏุนุงุก ูุงุฌูุฉ Gemini API ูุน ุงูุญูููุฉ ุงููุญุฏุฏุฉ.
 * @param payload ุงูุญูููุฉ ุงูุชู ุณูุชู ุฅุฑุณุงููุง ุฅูู Gemini API.
 * @returns Promise ูุญู ุฅูู ุงููุญุชูู ุงููุตู ุงูุฐู ุชู ุฅูุดุงุคู.
 */
export const callGeminiAPI = async (payload: GeminiPayload): Promise<string> => {
  // ููุงุญุธุฉ: ูู ุชุทุจูู ุญููููุ ูุฌุจ ุชุฎุฒูู ููุชุงุญ API ุจุดูู ุขูู.
  // ูู ูุฐุง ุงูุนุฑุถ ุงูุชูุถูุญูุ ุณูุณุชุฎุฏู ูููุฉ ูุคูุชุฉ ูุฌุจ ุงุณุชุจุฏุงููุง.
  const apiKey: string = "YOUR_GEMINI_API_KEY_HERE"; 
  
  if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY_HERE") {
    throw new Error("ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ API ุงูุฎุงุต ุจู Gemini ูู ููู ุงูุฎุฏูุฉ");
  }
  
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${apiKey}`;
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData: ApiErrorResponse = await response.json();
      throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
    }

    const result: GeminiApiResponse = await response.json();
    return result.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (error) {
    console.error('Gemini API Error:', error);
    // ุฅุนุงุฏุฉ ุฑูู ุงูุฎุทุฃ ููุชู ุงูุชุนุงูู ูุนู ูู ูุจู ุงูุฌูุฉ ุงููุณุชุฏุนูุฉ
    throw error;
  }
};

/**
 * ุชููู ุจุจูุงุก ูุงุฆู ุงูุญูููุฉ (payload) ุงูุฎุงุต ุจุงุณุชุฏุนุงุก Gemini API.
 * @param instruction ุงูุชุนูููุงุช ุงููุตูุฉ ุงูุฑุฆูุณูุฉ ูููููุฐุฌ.
 * @param files ูุตูููุฉ ูู ุงููููุงุช (ูุตูุฉ ุฃู ุจุชุฑููุฒ base64) ูุฅุฏุฑุงุฌูุง ูู ุงูุทูุจ.
 * @returns ูุงุฆู ุงูุญูููุฉ ุงููุจูู ุจุงููุงูู.
 */
export const buildGeminiPayload = (instruction: string, files: GeminiFile[]): GeminiPayload => {
  const parts: ApiPart[] = [{ text: instruction }];
  
  // ุฅุถุงูุฉ ูุญุชููุงุช ุงููููุงุช ุฅูู ุงูุญูููุฉ
  if (files && files.length > 0) {
    files.forEach((file: GeminiFile) => {
      if (file.isBase64) {
        // ููุตูุฑ ููููุงุช PDF
        parts.push({
          inline_data: {
            mime_type: file.mimeType,
            data: file.content
          }
        });
      } else {
        // ูููููุงุช ุงููุตูุฉ
        parts.push({
          text: `\n\n--- ูุญุชูู ุงูููู: ${file.name} ---\n${file.content}\n--- ููุงูุฉ ุงูููู ---\n`
        });
      }
    });
  }

  return {
    contents: [{
      parts: parts
    }],
    generationConfig: {
      temperature: 0.7,
      topK: 40,
      topP: 0.95,
      maxOutputTokens: 8192,
    }
  };
};
```
